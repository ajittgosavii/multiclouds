"""
Vulnerability Scanning Plugin System
================================================================================
Enterprise-grade plugin architecture for integrating security scanning tools

Supported Scanners:
-------------------
Container Scanning:
  - Trivy (vulnerability scanner)
  - Snyk (container security)
  - AWS Inspector v2
  - Aqua Security
  - Clair

Policy & Compliance:
  - Open Policy Agent (OPA)
  - KICS (Keeping Infrastructure as Code Secure)
  - Checkov
  - tfsec
  - Terrascan

OS Vulnerability Scanning:
  - Windows Server (2012 R2, 2016, 2019, 2022, 2025)
  - Amazon Linux 2 / AL2023
  - Red Hat Enterprise Linux (7, 8, 9)
  - Ubuntu (18.04, 20.04, 22.04, 24.04)
  - CentOS / Rocky Linux / AlmaLinux
  - Debian
  - SUSE Linux Enterprise

EKS & Kubernetes:
  - Kube-bench (CIS Kubernetes benchmark)
  - Kube-hunter (penetration testing)
  - Falco (runtime security)
  - Polaris (best practices)

Cloud Security:
  - AWS Security Hub
  - Azure Security Center
  - GCP Security Command Center
  - Prowler (AWS security)
  - ScoutSuite (multi-cloud)

================================================================================
"""

import streamlit as st
import pandas as pd
import json
from typing import Dict, List, Any, Optional
from datetime import datetime, timedelta
from abc import ABC, abstractmethod
import requests

# ============================================================================
# BASE PLUGIN ARCHITECTURE
# ============================================================================

class VulnerabilityScannerPlugin(ABC):
    """Base class for all vulnerability scanner plugins"""
    
    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.name = self.__class__.__name__
        self.enabled = config.get('enabled', True)
        self.api_url = config.get('api_url', '')
        self.api_key = config.get('api_key', '')
    
    @abstractmethod
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Execute vulnerability scan"""
        pass
    
    @abstractmethod
    def get_results(self) -> List[Dict[str, Any]]:
        """Retrieve scan results"""
        pass
    
    @abstractmethod
    def get_metadata(self) -> Dict[str, Any]:
        """Get scanner metadata"""
        pass
    
    def validate_config(self) -> bool:
        """Validate scanner configuration"""
        return self.enabled and bool(self.api_url)

# ============================================================================
# CONTAINER SCANNING PLUGINS
# ============================================================================

class TrivyScanner(VulnerabilityScannerPlugin):
    """Trivy container vulnerability scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Trivy',
            'category': 'Container Security',
            'vendor': 'Aqua Security',
            'version': '0.48.0',
            'supports': ['containers', 'images', 'filesystems', 'git'],
            'severity_levels': ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN'],
            'cve_database': 'NVD, GHSA, etc.',
            'license': 'Apache 2.0'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan container image with Trivy"""
        image = target.get('image', '')
        scan_type = target.get('type', 'image')
        
        # Sample implementation - replace with actual Trivy API call
        return {
            'scanner': 'Trivy',
            'target': image,
            'scan_time': datetime.now().isoformat(),
            'vulnerabilities': self._get_sample_vulnerabilities(),
            'summary': {
                'critical': 3,
                'high': 12,
                'medium': 45,
                'low': 89
            }
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        """Get latest scan results"""
        return self._get_sample_vulnerabilities()
    
    def _get_sample_vulnerabilities(self) -> List[Dict[str, Any]]:
        """Sample vulnerability data"""
        return [
            {
                'cve_id': 'CVE-2023-12345',
                'severity': 'CRITICAL',
                'cvss_score': 9.8,
                'package': 'openssl',
                'installed_version': '1.1.1k',
                'fixed_version': '1.1.1w',
                'description': 'Buffer overflow vulnerability in OpenSSL',
                'remediation': 'Upgrade to openssl 1.1.1w or later'
            },
            {
                'cve_id': 'CVE-2023-23456',
                'severity': 'HIGH',
                'cvss_score': 7.5,
                'package': 'curl',
                'installed_version': '7.68.0',
                'fixed_version': '7.88.0',
                'description': 'Remote code execution in curl',
                'remediation': 'Update curl to 7.88.0'
            }
        ]

class SnykScanner(VulnerabilityScannerPlugin):
    """Snyk container and dependency scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Snyk',
            'category': 'Container Security',
            'vendor': 'Snyk',
            'version': 'latest',
            'supports': ['containers', 'dependencies', 'code', 'infrastructure'],
            'severity_levels': ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'],
            'license': 'Proprietary'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan with Snyk"""
        return {
            'scanner': 'Snyk',
            'target': target.get('image', ''),
            'scan_time': datetime.now().isoformat(),
            'vulnerabilities': [],
            'licenses': [],
            'summary': {'critical': 2, 'high': 8, 'medium': 25, 'low': 50}
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

class AWSInspectorV2Scanner(VulnerabilityScannerPlugin):
    """AWS Inspector v2 scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'AWS Inspector v2',
            'category': 'Cloud Security',
            'vendor': 'Amazon Web Services',
            'version': 'v2',
            'supports': ['ec2', 'ecr', 'lambda'],
            'severity_levels': ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFORMATIONAL']
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan with AWS Inspector v2"""
        return {
            'scanner': 'AWS Inspector v2',
            'target': target.get('resource_arn', ''),
            'scan_time': datetime.now().isoformat(),
            'findings': []
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

# ============================================================================
# POLICY & COMPLIANCE PLUGINS
# ============================================================================

class OPAScanner(VulnerabilityScannerPlugin):
    """Open Policy Agent scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Open Policy Agent (OPA)',
            'category': 'Policy as Code',
            'vendor': 'CNCF',
            'version': '0.58.0',
            'supports': ['kubernetes', 'terraform', 'docker', 'envoy'],
            'policy_language': 'Rego',
            'license': 'Apache 2.0'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Evaluate policies with OPA"""
        return {
            'scanner': 'OPA',
            'target': target.get('resource', ''),
            'scan_time': datetime.now().isoformat(),
            'policy_violations': [],
            'passed_policies': [],
            'summary': {
                'total_policies': 50,
                'passed': 42,
                'failed': 8
            }
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

class KICSScanner(VulnerabilityScannerPlugin):
    """KICS Infrastructure as Code scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'KICS',
            'category': 'IaC Security',
            'vendor': 'Checkmarx',
            'version': 'latest',
            'supports': ['terraform', 'cloudformation', 'kubernetes', 'ansible', 'dockerfile'],
            'severity_levels': ['HIGH', 'MEDIUM', 'LOW', 'INFO'],
            'license': 'Apache 2.0'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan IaC with KICS"""
        return {
            'scanner': 'KICS',
            'target': target.get('iac_path', ''),
            'scan_time': datetime.now().isoformat(),
            'findings': [],
            'summary': {'high': 5, 'medium': 15, 'low': 30, 'info': 45}
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

# ============================================================================
# OS VULNERABILITY SCANNING PLUGINS
# ============================================================================

class WindowsServerScanner(VulnerabilityScannerPlugin):
    """Windows Server vulnerability scanner"""
    
    SUPPORTED_VERSIONS = {
        'Windows Server 2025': {'build': '26100', 'eol': '2034-10-10'},
        'Windows Server 2022': {'build': '20348', 'eol': '2031-10-14'},
        'Windows Server 2019': {'build': '17763', 'eol': '2029-01-09'},
        'Windows Server 2016': {'build': '14393', 'eol': '2027-01-12'},
        'Windows Server 2012 R2': {'build': '9600', 'eol': '2023-10-10'}
    }
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Windows Server Scanner',
            'category': 'OS Vulnerability',
            'vendor': 'Microsoft',
            'supported_versions': list(self.SUPPORTED_VERSIONS.keys()),
            'patch_sources': ['Windows Update', 'WSUS', 'SCCM'],
            'scan_methods': ['Windows Update API', 'PowerShell', 'WMI']
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan Windows Server for vulnerabilities"""
        instance_id = target.get('instance_id', '')
        os_version = target.get('os_version', 'Windows Server 2022')
        
        return {
            'scanner': 'Windows Server Scanner',
            'target': instance_id,
            'os_version': os_version,
            'scan_time': datetime.now().isoformat(),
            'missing_patches': self._get_windows_patches(),
            'summary': {
                'critical': 5,
                'important': 12,
                'moderate': 8,
                'low': 3
            }
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return self._get_windows_patches()
    
    def _get_windows_patches(self) -> List[Dict[str, Any]]:
        """Sample Windows patches"""
        return [
            {
                'kb_id': 'KB5034439',
                'title': 'Security Update for Windows Server 2022',
                'severity': 'Critical',
                'release_date': '2024-01-09',
                'description': 'Addresses remote code execution vulnerability',
                'cve_ids': ['CVE-2024-0001', 'CVE-2024-0002'],
                'reboot_required': True
            },
            {
                'kb_id': 'KB5034127',
                'title': 'Cumulative Update for Windows Server',
                'severity': 'Important',
                'release_date': '2024-01-09',
                'description': 'Quality and security improvements',
                'cve_ids': ['CVE-2024-0003'],
                'reboot_required': True
            }
        ]

class LinuxDistributionScanner(VulnerabilityScannerPlugin):
    """Linux distribution vulnerability scanner"""
    
    SUPPORTED_DISTRIBUTIONS = {
        'Amazon Linux 2': {'package_manager': 'yum', 'eol': '2025-06-30'},
        'Amazon Linux 2023': {'package_manager': 'dnf', 'eol': '2028-03-15'},
        'Red Hat Enterprise Linux 9': {'package_manager': 'dnf', 'eol': '2032-05-31'},
        'Red Hat Enterprise Linux 8': {'package_manager': 'dnf', 'eol': '2029-05-31'},
        'Red Hat Enterprise Linux 7': {'package_manager': 'yum', 'eol': '2024-06-30'},
        'Ubuntu 24.04 LTS': {'package_manager': 'apt', 'eol': '2029-04-01'},
        'Ubuntu 22.04 LTS': {'package_manager': 'apt', 'eol': '2027-04-01'},
        'Ubuntu 20.04 LTS': {'package_manager': 'apt', 'eol': '2025-04-01'},
        'Ubuntu 18.04 LTS': {'package_manager': 'apt', 'eol': '2023-05-31'},
        'CentOS Stream 9': {'package_manager': 'dnf', 'eol': '2027-05-31'},
        'Rocky Linux 9': {'package_manager': 'dnf', 'eol': '2032-05-31'},
        'AlmaLinux 9': {'package_manager': 'dnf', 'eol': '2032-05-31'}
    }
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Linux Distribution Scanner',
            'category': 'OS Vulnerability',
            'supported_distributions': list(self.SUPPORTED_DISTRIBUTIONS.keys()),
            'scan_methods': ['yum check-update', 'apt list --upgradable', 'dnf check-update'],
            'cve_databases': ['NVD', 'Ubuntu Security', 'Red Hat CVE', 'Amazon ALAS']
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Scan Linux distribution for vulnerabilities"""
        instance_id = target.get('instance_id', '')
        distribution = target.get('distribution', 'Amazon Linux 2')
        
        return {
            'scanner': 'Linux Distribution Scanner',
            'target': instance_id,
            'distribution': distribution,
            'scan_time': datetime.now().isoformat(),
            'vulnerable_packages': self._get_linux_vulnerabilities(),
            'summary': {
                'critical': 8,
                'high': 23,
                'medium': 45,
                'low': 67
            }
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return self._get_linux_vulnerabilities()
    
    def _get_linux_vulnerabilities(self) -> List[Dict[str, Any]]:
        """Sample Linux vulnerabilities"""
        return [
            {
                'package': 'openssl',
                'current_version': '1.1.1k-3',
                'fixed_version': '1.1.1w-1',
                'severity': 'Critical',
                'cve_ids': ['CVE-2023-3446', 'CVE-2023-3817'],
                'description': 'Multiple vulnerabilities in OpenSSL',
                'advisory_id': 'ALAS-2023-1825'
            },
            {
                'package': 'kernel',
                'current_version': '5.10.184-175',
                'fixed_version': '5.10.192-183',
                'severity': 'High',
                'cve_ids': ['CVE-2023-4622'],
                'description': 'Privilege escalation in kernel',
                'advisory_id': 'ALAS-2023-1842'
            }
        ]

# ============================================================================
# EKS & KUBERNETES PLUGINS
# ============================================================================

class KubeBenchScanner(VulnerabilityScannerPlugin):
    """CIS Kubernetes Benchmark scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'kube-bench',
            'category': 'Kubernetes Security',
            'vendor': 'Aqua Security',
            'version': '0.7.0',
            'benchmarks': ['CIS Kubernetes 1.23', 'CIS Kubernetes 1.24', 'CIS EKS'],
            'license': 'Apache 2.0'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Run CIS benchmark scan"""
        cluster_name = target.get('cluster_name', '')
        
        return {
            'scanner': 'kube-bench',
            'target': cluster_name,
            'scan_time': datetime.now().isoformat(),
            'benchmark': 'CIS Kubernetes 1.24',
            'results': {
                'passed': 45,
                'failed': 12,
                'warnings': 8,
                'total': 65
            }
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

class FalcoScanner(VulnerabilityScannerPlugin):
    """Falco runtime security scanner"""
    
    def get_metadata(self) -> Dict[str, Any]:
        return {
            'name': 'Falco',
            'category': 'Runtime Security',
            'vendor': 'CNCF',
            'version': '0.36.0',
            'detection_types': ['syscalls', 'k8s_audit', 'network'],
            'license': 'Apache 2.0'
        }
    
    def scan(self, target: Dict[str, Any]) -> Dict[str, Any]:
        """Monitor runtime security events"""
        return {
            'scanner': 'Falco',
            'target': target.get('cluster_name', ''),
            'scan_time': datetime.now().isoformat(),
            'alerts': [],
            'summary': {'critical': 2, 'warning': 15, 'info': 50}
        }
    
    def get_results(self) -> List[Dict[str, Any]]:
        return []

# ============================================================================
# PLUGIN REGISTRY & MANAGER
# ============================================================================

class PluginRegistry:
    """Central registry for all scanner plugins"""
    
    def __init__(self):
        self.plugins: Dict[str, VulnerabilityScannerPlugin] = {}
        self._register_default_plugins()
    
    def _register_default_plugins(self):
        """Register all available plugins"""
        
        # Container scanners
        self.register('trivy', TrivyScanner({
            'enabled': True,
            'api_url': 'http://trivy-server:8080'
        }))
        
        self.register('snyk', SnykScanner({
            'enabled': True,
            'api_url': 'https://api.snyk.io/v1'
        }))
        
        self.register('aws_inspector', AWSInspectorV2Scanner({
            'enabled': True
        }))
        
        # Policy scanners
        self.register('opa', OPAScanner({
            'enabled': True,
            'api_url': 'http://opa-server:8181'
        }))
        
        self.register('kics', KICSScanner({
            'enabled': True
        }))
        
        # OS scanners
        self.register('windows_server', WindowsServerScanner({
            'enabled': True
        }))
        
        self.register('linux_distro', LinuxDistributionScanner({
            'enabled': True
        }))
        
        # Kubernetes scanners
        self.register('kube_bench', KubeBenchScanner({
            'enabled': True
        }))
        
        self.register('falco', FalcoScanner({
            'enabled': True
        }))
    
    def register(self, name: str, plugin: VulnerabilityScannerPlugin):
        """Register a new plugin"""
        self.plugins[name] = plugin
    
    def get_plugin(self, name: str) -> Optional[VulnerabilityScannerPlugin]:
        """Get plugin by name"""
        return self.plugins.get(name)
    
    def get_all_plugins(self) -> Dict[str, VulnerabilityScannerPlugin]:
        """Get all registered plugins"""
        return self.plugins
    
    def get_enabled_plugins(self) -> Dict[str, VulnerabilityScannerPlugin]:
        """Get only enabled plugins"""
        return {name: plugin for name, plugin in self.plugins.items() if plugin.enabled}
    
    def get_plugins_by_category(self, category: str) -> Dict[str, VulnerabilityScannerPlugin]:
        """Get plugins by category"""
        return {
            name: plugin for name, plugin in self.plugins.items()
            if plugin.get_metadata().get('category') == category
        }

# ============================================================================
# STREAMLIT UI COMPONENTS
# ============================================================================

class PluginUI:
    """Streamlit UI for plugin management"""
    
    @staticmethod
    def render_plugin_selector(registry: PluginRegistry):
        """Render plugin selection interface"""
        st.markdown("### ðŸ”Œ Scanner Plugins")
        
        categories = {
            'Container Security': [],
            'Policy as Code': [],
            'OS Vulnerability': [],
            'Kubernetes Security': [],
            'Runtime Security': [],
            'Cloud Security': [],
            'IaC Security': []
        }
        
        # Categorize plugins
        for name, plugin in registry.get_all_plugins().items():
            metadata = plugin.get_metadata()
            category = metadata.get('category', 'Other')
            if category in categories:
                categories[category].append((name, plugin, metadata))
        
        # Display by category
        for category, plugins in categories.items():
            if plugins:
                with st.expander(f"**{category}** ({len(plugins)} plugins)", expanded=True):
                    for name, plugin, metadata in plugins:
                        col1, col2, col3 = st.columns([3, 1, 1])
                        
                        with col1:
                            st.markdown(f"**{metadata.get('name', name)}**")
                            st.caption(f"Vendor: {metadata.get('vendor', 'Unknown')}")
                            if 'supports' in metadata:
                                st.caption(f"Supports: {', '.join(metadata['supports'][:3])}")
                        
                        with col2:
                            enabled = st.checkbox(
                                "Enabled",
                                value=plugin.enabled,
                                key=f"plugin_enabled_{name}"
                            )
                        
                        with col3:
                            if st.button("Configure", key=f"plugin_config_{name}"):
                                st.info(f"Configuration for {metadata.get('name')}")
    
    @staticmethod
    def render_scan_results(results: List[Dict[str, Any]]):
        """Render scan results"""
        if not results:
            st.info("No vulnerabilities found")
            return
        
        # Summary metrics
        col1, col2, col3, col4 = st.columns(4)
        
        critical = sum(1 for r in results if r.get('severity') == 'CRITICAL')
        high = sum(1 for r in results if r.get('severity') == 'HIGH')
        medium = sum(1 for r in results if r.get('severity') == 'MEDIUM')
        low = sum(1 for r in results if r.get('severity') == 'LOW')
        
        with col1:
            st.metric("Critical", critical, delta=None, delta_color="inverse")
        
        with col2:
            st.metric("High", high)
        
        with col3:
            st.metric("Medium", medium)
        
        with col4:
            st.metric("Low", low)
        
        # Results table
        df = pd.DataFrame(results)
        st.dataframe(df, use_container_width=True)

# ============================================================================
# EXPORT
# ============================================================================

__all__ = [
    'VulnerabilityScannerPlugin',
    'TrivyScanner',
    'SnykScanner',
    'AWSInspectorV2Scanner',
    'OPAScanner',
    'KICSScanner',
    'WindowsServerScanner',
    'LinuxDistributionScanner',
    'KubeBenchScanner',
    'FalcoScanner',
    'PluginRegistry',
    'PluginUI'
]