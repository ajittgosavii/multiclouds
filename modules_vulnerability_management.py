"""
üõ°Ô∏è Comprehensive Vulnerability Management Module
Enterprise-grade vulnerability scanning and remediation for OS, Containers, and EKS

Features:
- OS Vulnerability Scanning (Windows, Linux)
- Container Vulnerability Scanning (Trivy, Snyk, AWS Inspector)
- EKS Application Vulnerabilities
- NIST Database Integration
- Native AWS Tool Integration (Inspector, Security Hub)
- Third-Party Plugin Support (Qualys, Trivy, Snyk, Aqua, etc.)
- Auto-Remediation Engine
- Compliance Mapping (PCI-DSS, HIPAA, SOC 2, ISO 27001, NIST)
"""

import streamlit as st
import pandas as pd
import boto3
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import json
import uuid

# ============================================================================
# PLUGIN SYSTEM INTEGRATION (Optional - graceful fallback if not available)
# ============================================================================
try:
    from vulnerability_scanner_plugins import (
        PluginRegistry,
        PluginUI,
        TrivyScanner,
        SnykScanner,
        WindowsServerScanner,
        LinuxDistributionScanner,
        OPAScanner,
        KICSScanner,
        KubeBenchScanner,
        FalcoScanner,
        AWSInspectorV2Scanner
    )
    PLUGIN_SYSTEM_AVAILABLE = True
except ImportError:
    PLUGIN_SYSTEM_AVAILABLE = False

class VulnerabilityManagementModule:
    """Comprehensive Vulnerability Management System"""
    
    @staticmethod
    def render(session, region: str):
        """Main render method for vulnerability management"""
        
        # Generate unique session ID for button keys (must be inside render method)
        if 'vuln_session_id' not in st.session_state:
            st.session_state.vuln_session_id = str(uuid.uuid4())[:8]
        
        st.markdown("## üõ°Ô∏è Vulnerability Management")
        st.info("üîç Comprehensive vulnerability scanning and remediation for OS, containers, and applications")
        
        # Initialize plugin registry
        if PLUGIN_SYSTEM_AVAILABLE:
            if 'vuln_plugin_registry' not in st.session_state:
                st.session_state.vuln_plugin_registry = PluginRegistry()
            registry = st.session_state.vuln_plugin_registry
            st.success("‚úÖ Enhanced with modular scanner plugin system")
        else:
            registry = None
        
        # Main tabs
        tabs = st.tabs([
            "üìä Dashboard",
            "üñ•Ô∏è OS Vulnerabilities",
            "üê≥ Container Vulnerabilities",
            "‚ò∏Ô∏è EKS/K8s Vulnerabilities",
            "üîß Auto-Remediation",
            "üîå Scanner Integration",
            "üéõÔ∏è Plugin Management"  # NEW TAB
        ])
        
        with tabs[0]:
            VulnerabilityManagementModule._render_dashboard(session, region, registry)
        
        with tabs[1]:
            VulnerabilityManagementModule._render_os_vulnerabilities(session, region, registry)
        
        with tabs[2]:
            VulnerabilityManagementModule._render_container_vulnerabilities(session, region, registry)
        
        with tabs[3]:
            VulnerabilityManagementModule._render_eks_vulnerabilities(session, region, registry)
        
        with tabs[4]:
            VulnerabilityManagementModule._render_auto_remediation(session, region)
        
        with tabs[5]:
            VulnerabilityManagementModule._render_scanner_integration(session, region)
        
        with tabs[6]:
            # NEW: Plugin Management Tab
            if PLUGIN_SYSTEM_AVAILABLE and registry:
                VulnerabilityManagementModule._render_plugin_management(registry)
            else:
                st.error("‚ùå Plugin system not installed")
                st.info("Install vulnerability_scanner_plugins.py to enable plugin management")
    
    @staticmethod
    def _render_dashboard(session, region: str, registry=None):
        """Vulnerability Management Dashboard"""
        st.markdown("### üìä Vulnerability Overview Dashboard")
        
        # Overall metrics
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric(
                "Total Vulnerabilities",
                "247",
                delta="‚Üì 23 from last week",
                delta_color="normal"
            )
        
        with col2:
            st.metric(
                "Critical CVEs",
                "12",
                delta="‚Üì 5 (remediated)",
                delta_color="normal"
            )
        
        with col3:
            st.metric(
                "Affected Resources",
                "89",
                delta="Across 3 platforms"
            )
        
        with col4:
            st.metric(
                "Remediation Rate",
                "87%",
                delta="‚Üë 12%"
            )
        
        st.markdown("---")
        
        # Vulnerability breakdown by platform
        st.markdown("### üéØ Vulnerability Distribution")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # By platform
            platform_data = pd.DataFrame({
                'Platform': ['Windows Servers', 'Linux Servers', 'Docker Containers', 'EKS Pods', 'Lambda Functions'],
                'Critical': [5, 3, 2, 2, 0],
                'High': [12, 15, 8, 10, 2],
                'Medium': [25, 30, 20, 18, 5],
                'Low': [40, 45, 35, 28, 8]
            })
            
            st.dataframe(platform_data, use_container_width=True, hide_index=True)
        
        with col2:
            # By severity over time
            severity_trend = {
                'Week': ['4 weeks ago', '3 weeks ago', '2 weeks ago', 'Last week', 'This week'],
                'Critical': [20, 18, 15, 17, 12],
                'High': [65, 60, 55, 52, 47]
            }
            
            df_trend = pd.DataFrame(severity_trend).set_index('Week')
            st.line_chart(df_trend)
        
        st.markdown("---")
        
        # Top vulnerabilities
        st.markdown("### üö® Top Critical Vulnerabilities")
        
        critical_vulns = [
            {
                'CVE': 'CVE-2024-1234',
                'Severity': 'üî¥ Critical',
                'CVSS': '9.8',
                'Affected': '12 Windows Servers',
                'Description': 'Remote Code Execution in Windows Server',
                'NIST': 'SI-2, RA-5',
                'Status': 'Patch Available',
                'Action': 'Auto-Remediate'
            },
            {
                'CVE': 'CVE-2024-5678',
                'Severity': 'üî¥ Critical',
                'CVSS': '9.1',
                'Affected': '8 Docker Images',
                'Description': 'Container Escape Vulnerability',
                'NIST': 'SI-2, SC-39',
                'Status': 'Rebuild Required',
                'Action': 'Manual Review'
            },
            {
                'CVE': 'CVE-2024-9012',
                'Severity': 'üü† High',
                'CVSS': '8.6',
                'Affected': '15 Ubuntu Instances',
                'Description': 'Privilege Escalation in sudo',
                'NIST': 'AC-6, SI-2',
                'Status': 'Patch Available',
                'Action': 'Auto-Remediate'
            },
            {
                'CVE': 'CVE-2024-3456',
                'Severity': 'üü† High',
                'CVSS': '7.8',
                'Affected': '5 EKS Clusters',
                'Description': 'Kubernetes API Server DoS',
                'NIST': 'SC-5, SI-2',
                'Status': 'Upgrade Required',
                'Action': 'Schedule Maintenance'
            }
        ]
        
        df_critical = pd.DataFrame(critical_vulns)
        st.dataframe(df_critical, use_container_width=True, hide_index=True)
        
        # Action buttons
        st.markdown("---")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button("üîÑ Scan All Resources", key="vuln_scan_all", use_container_width=True):
                with st.spinner("Scanning all resources..."):
                    import time
                    time.sleep(2)
                    st.success("‚úÖ Scan complete! Found 8 new vulnerabilities")
        
        with col2:
            if st.button("‚ö° Auto-Remediate All", type="primary", key="vuln_auto_rem_all", use_container_width=True):
                st.warning("This will remediate 45 vulnerabilities automatically. Proceed?")
        
        with col3:
            if st.button("üìä Generate Report", key="vuln_gen_report_dash", use_container_width=True):
                st.info("Generating comprehensive vulnerability report...")
        
        with col4:
            if st.button("üìß Alert Security Team", key="vuln_alert_team", use_container_width=True):
                st.success("Security team notified of critical vulnerabilities")
    
    @staticmethod
    def _render_os_vulnerabilities(session, region: str, registry=None):
        """OS Vulnerability Scanning and Remediation"""
        st.markdown("### üñ•Ô∏è Operating System Vulnerabilities")
        st.info("Scan and remediate vulnerabilities in Windows and Linux servers")
        
        # OS Type selector
        os_type = st.selectbox(
            "Select Operating System Type",
            options=["All OS Types", "Windows Server", "Linux (All Distributions)", 
                    "Amazon Linux", "Ubuntu", "RHEL", "CentOS"],
            key="os_type_filter"
        )
        
        # Scan configuration
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown("#### üîç Scan Configuration")
            
            scan_type = st.radio(
                "Scan Type",
                options=["Quick Scan (Critical & High)", "Full Scan (All Severities)", "Compliance Scan (NIST)"],
                horizontal=True,
                key="os_scan_type"
            )
            
            scan_targets = st.multiselect(
                "Select Instances to Scan",
                options=[
                    "prod-web-01 (Windows Server 2022)",
                    "prod-web-02 (Windows Server 2022)",
                    "prod-db-01 (Windows Server 2019)",
                    "prod-app-01 (Ubuntu 22.04)",
                    "prod-app-02 (Amazon Linux 2023)",
                    "dev-test-01 (RHEL 9)",
                    "All Windows Instances (12)",
                    "All Linux Instances (24)"
                ],
                default=["All Windows Instances (12)", "All Linux Instances (24)"],
                key="os_scan_targets"
            )
        
        with col2:
            st.markdown("#### ‚öôÔ∏è Scanner Options")
            
            st.checkbox("‚úÖ AWS Inspector v2", value=True, key="use_inspector")
            st.checkbox("‚úÖ AWS Security Hub", value=True, key="use_security_hub")
            st.checkbox("‚ñ° Qualys Cloud Agent", value=False, key="use_qualys")
            st.checkbox("‚ñ° Rapid7 InsightVM", value=False, key="use_rapid7")
            st.checkbox("‚úÖ NIST NVD Database", value=True, key="use_nist")
            
            st.markdown("---")
            st.metric("Est. Scan Time", "3-5 min")
        
        if st.button("üöÄ Start OS Vulnerability Scan", type="primary", key="vuln_start_os_scan", use_container_width=True):
            with st.spinner("Scanning operating systems..."):
                import time
                
                # Simulate scan progress
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                stages = [
                    ("Connecting to AWS Inspector...", 20),
                    ("Scanning Windows instances...", 40),
                    ("Scanning Linux instances...", 60),
                    ("Querying NIST database...", 80),
                    ("Analyzing results...", 100)
                ]
                
                for stage, progress in stages:
                    status_text.text(stage)
                    progress_bar.progress(progress)
                    time.sleep(0.8)
                
                status_text.empty()
                progress_bar.empty()
                
                st.success("‚úÖ Scan complete! Found 89 vulnerabilities across 36 instances")
        
        st.markdown("---")
        
        # Scan results
        st.markdown("### üìã OS Vulnerability Scan Results")
        
        # Windows vulnerabilities
        with st.expander("ü™ü Windows Server Vulnerabilities (45)", expanded=True):
            windows_vulns = [
                {
                    'Instance': 'prod-web-01',
                    'OS': 'Windows Server 2022',
                    'CVE': 'CVE-2024-1234',
                    'Severity': 'üî¥ Critical',
                    'CVSS': '9.8',
                    'Package': 'Windows Update KB5034441',
                    'Description': 'Remote Code Execution',
                    'NIST': 'SI-2',
                    'Remediation': 'Install KB5034441',
                    'Confidence': '95%'
                },
                {
                    'Instance': 'prod-db-01',
                    'OS': 'Windows Server 2019',
                    'CVE': 'CVE-2024-2345',
                    'Severity': 'üü† High',
                    'CVSS': '8.1',
                    'Package': 'Windows Update KB5034127',
                    'Description': 'Privilege Escalation',
                    'NIST': 'AC-6, SI-2',
                    'Remediation': 'Install KB5034127',
                    'Confidence': '98%'
                },
                {
                    'Instance': 'prod-web-02',
                    'OS': 'Windows Server 2022',
                    'CVE': 'CVE-2024-3456',
                    'Severity': 'üü° Medium',
                    'CVSS': '6.5',
                    'Package': 'IIS 10.0',
                    'Description': 'Information Disclosure',
                    'NIST': 'SI-2, SC-28',
                    'Remediation': 'Apply IIS patch',
                    'Confidence': '92%'
                }
            ]
            
            df_windows = pd.DataFrame(windows_vulns)
            st.dataframe(df_windows, use_container_width=True, hide_index=True)
            
            col1, col2, col3 = st.columns(3)
            with col1:
                if st.button("‚ö° Auto-Remediate Windows (Critical)", key="auto_rem_win", use_container_width=True):
                    st.success("‚úÖ Scheduled remediation for 12 critical vulnerabilities")
            with col2:
                if st.button("üìã Export Windows Report", key="export_win", use_container_width=True):
                    st.info("Report exported to S3")
            with col3:
                if st.button("üîÑ Rescan Windows", key="rescan_win", use_container_width=True):
                    st.info("Rescanning Windows instances...")
        
        # Linux vulnerabilities
        with st.expander("üêß Linux Distribution Vulnerabilities (44)", expanded=True):
            linux_vulns = [
                {
                    'Instance': 'prod-app-01',
                    'Distribution': 'Ubuntu 22.04',
                    'CVE': 'CVE-2024-9012',
                    'Severity': 'üî¥ Critical',
                    'CVSS': '9.1',
                    'Package': 'sudo 1.9.9',
                    'Description': 'Privilege Escalation',
                    'NIST': 'AC-6, SI-2',
                    'Remediation': 'apt upgrade sudo',
                    'Confidence': '99%'
                },
                {
                    'Instance': 'prod-app-02',
                    'Distribution': 'Amazon Linux 2023',
                    'CVE': 'CVE-2024-4567',
                    'Severity': 'üü† High',
                    'CVSS': '7.8',
                    'Package': 'kernel 6.1.29',
                    'Description': 'Kernel Memory Leak',
                    'NIST': 'SI-2, SC-39',
                    'Remediation': 'yum update kernel',
                    'Confidence': '96%'
                },
                {
                    'Instance': 'dev-test-01',
                    'Distribution': 'RHEL 9',
                    'CVE': 'CVE-2024-7890',
                    'Severity': 'üü† High',
                    'CVSS': '8.4',
                    'Package': 'openssl 3.0.7',
                    'Description': 'Cryptographic Weakness',
                    'NIST': 'SC-12, SC-13, SI-2',
                    'Remediation': 'dnf update openssl',
                    'Confidence': '97%'
                }
            ]
            
            df_linux = pd.DataFrame(linux_vulns)
            st.dataframe(df_linux, use_container_width=True, hide_index=True)
            
            col1, col2, col3 = st.columns(3)
            with col1:
                if st.button("‚ö° Auto-Remediate Linux (Critical)", key="auto_rem_linux", use_container_width=True):
                    st.success("‚úÖ Scheduled remediation for 8 critical vulnerabilities")
            with col2:
                if st.button("üìã Export Linux Report", key="export_linux", use_container_width=True):
                    st.info("Report exported to S3")
            with col3:
                if st.button("üîÑ Rescan Linux", key="rescan_linux", use_container_width=True):
                    st.info("Rescanning Linux instances...")
        
        # NIST Control Mapping
        st.markdown("---")
        st.markdown("### üìã NIST 800-53 Control Mapping")
        
        nist_mapping = pd.DataFrame({
            'NIST Control': ['SI-2 (Flaw Remediation)', 'AC-6 (Least Privilege)', 
                           'SC-28 (Protection of Information)', 'RA-5 (Vulnerability Scanning)'],
            'Vulnerabilities': [67, 12, 5, 89],
            'Critical': [8, 2, 0, 8],
            'Compliance': ['85%', '92%', '98%', '100%']
        })
        
        st.dataframe(nist_mapping, use_container_width=True, hide_index=True)
    
    @staticmethod
    def _render_container_vulnerabilities(session, region: str, registry=None):
        """Container Vulnerability Scanning"""
        st.markdown("### üê≥ Container & Image Vulnerabilities")
        st.info("Scan Docker containers and images for vulnerabilities using multiple scanners")
        
        # Scanner selection
        st.markdown("#### üîå Scanner Configuration")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("**AWS Native Tools:**")
            aws_inspector = st.checkbox("‚úÖ AWS Inspector v2", value=True, key="cont_inspector")
            ecr_scan = st.checkbox("‚úÖ ECR Image Scanning", value=True, key="cont_ecr")
            security_hub = st.checkbox("‚úÖ Security Hub", value=True, key="cont_hub")
        
        with col2:
            st.markdown("**Open Source:**")
            trivy = st.checkbox("‚úÖ Trivy", value=True, key="cont_trivy")
            grype = st.checkbox("‚ñ° Grype", value=False, key="cont_grype")
            clair = st.checkbox("‚ñ° Clair", value=False, key="cont_clair")
        
        with col3:
            st.markdown("**Commercial:**")
            snyk = st.checkbox("‚ñ° Snyk Container", value=False, key="cont_snyk")
            aqua = st.checkbox("‚ñ° Aqua Security", value=False, key="cont_aqua")
            qualys = st.checkbox("‚ñ° Qualys", value=False, key="cont_qualys")
        
        st.markdown("---")
        
        # Scan targets
        st.markdown("#### üéØ Scan Targets")
        
        target_type = st.radio(
            "Select Target Type",
            options=["ECR Repositories", "Running Containers", "Docker Images"],
            horizontal=True,
            key="container_target_type"
        )
        
        if target_type == "ECR Repositories":
            repositories = st.multiselect(
                "Select ECR Repositories",
                options=[
                    "prod/api-service",
                    "prod/web-frontend",
                    "prod/worker-service",
                    "staging/api-service",
                    "dev/test-app",
                    "All Repositories (24)"
                ],
                default=["All Repositories (24)"],
                key="ecr_repos"
            )
        
        if st.button("üöÄ Start Container Scan", type="primary", key="vuln_start_cont_scan", use_container_width=True):
            with st.spinner("Scanning containers..."):
                import time
                
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                stages = [
                    ("Initializing Trivy scanner...", 15),
                    ("Scanning base images...", 30),
                    ("Analyzing dependencies...", 50),
                    ("Checking for malware...", 70),
                    ("Querying vulnerability databases...", 85),
                    ("Generating report...", 100)
                ]
                
                for stage, progress in stages:
                    status_text.text(stage)
                    progress_bar.progress(progress)
                    time.sleep(0.6)
                
                status_text.empty()
                progress_bar.empty()
                
                st.success("‚úÖ Scan complete! Found 156 vulnerabilities in 24 images")
        
        st.markdown("---")
        
        # Container scan results
        st.markdown("### üìä Container Vulnerability Results")
        
        container_vulns = [
            {
                'Image': 'prod/api-service:v2.1.0',
                'Scanner': 'Trivy + AWS Inspector',
                'Base Image': 'python:3.11-slim',
                'Critical': 3,
                'High': 8,
                'Medium': 15,
                'CVE': 'CVE-2024-1111',
                'Package': 'urllib3==1.26.5',
                'Fix': 'Upgrade to 2.2.0',
                'SBOM': '‚úÖ Available'
            },
            {
                'Image': 'prod/web-frontend:v1.8.2',
                'Scanner': 'Trivy',
                'Base Image': 'node:18-alpine',
                'Critical': 1,
                'High': 4,
                'Medium': 12,
                'CVE': 'CVE-2024-2222',
                'Package': 'express@4.17.1',
                'Fix': 'Upgrade to 4.19.2',
                'SBOM': '‚úÖ Available'
            },
            {
                'Image': 'prod/worker-service:v3.0.1',
                'Scanner': 'Trivy + ECR Scan',
                'Base Image': 'alpine:3.18',
                'Critical': 0,
                'High': 2,
                'Medium': 8,
                'CVE': 'CVE-2024-3333',
                'Package': 'openssl@3.0.8',
                'Fix': 'Rebuild with alpine:3.19',
                'SBOM': '‚úÖ Available'
            }
        ]
        
        df_containers = pd.DataFrame(container_vulns)
        st.dataframe(df_containers, use_container_width=True, hide_index=True)
        
        # Container actions
        st.markdown("---")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button("üî® Rebuild Images", key="vuln_rebuild_imgs", use_container_width=True):
                st.info("Triggering CI/CD pipeline to rebuild images...")
        
        with col2:
            if st.button("üìã Generate SBOM", key="vuln_gen_sbom", use_container_width=True):
                st.success("Software Bill of Materials generated for all images")
        
        with col3:
            if st.button("üö´ Block Deployments", key="vuln_block_deploy", use_container_width=True):
                st.warning("Blocking deployments for images with Critical CVEs")
        
        with col4:
            if st.button("üìä Export Report", key="vuln_export_cont", use_container_width=True):
                st.info("Container vulnerability report exported")
        
        # Image recommendations
        st.markdown("---")
        st.markdown("### üí° Remediation Recommendations")
        
        recommendations = [
            "üî¥ **CRITICAL:** Upgrade urllib3 to 2.2.0 in prod/api-service",
            "üü† **HIGH:** Rebuild prod/web-frontend with node:20-alpine base image",
            "üü° **MEDIUM:** Update OpenSSL in worker-service to 3.1.4",
            "‚úÖ **AUTOMATED:** 12 images can be auto-patched using Copacetic",
            "üì¶ **BEST PRACTICE:** Enable ECR scan-on-push for all repositories"
        ]
        
        for rec in recommendations:
            st.markdown(f"- {rec}")
    
    @staticmethod
    def _render_eks_vulnerabilities(session, region: str, registry=None):
        """EKS and Kubernetes Vulnerability Scanning"""
        st.markdown("### ‚ò∏Ô∏è EKS & Kubernetes Vulnerabilities")
        st.info("Scan EKS clusters for application and runtime vulnerabilities")
        
        # Cluster selection
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown("#### üéØ Select EKS Clusters")
            
            clusters = st.multiselect(
                "EKS Clusters",
                options=[
                    "prod-eks-cluster-01 (1.28)",
                    "prod-eks-cluster-02 (1.28)",
                    "staging-eks-cluster (1.27)",
                    "dev-eks-cluster (1.29)",
                    "All Clusters (4)"
                ],
                default=["All Clusters (4)"],
                key="eks_clusters"
            )
            
            scan_scope = st.multiselect(
                "Scan Scope",
                options=[
                    "Running Pods",
                    "Deployments",
                    "StatefulSets",
                    "DaemonSets",
                    "CronJobs",
                    "Kubernetes API Server",
                    "Node OS",
                    "Network Policies"
                ],
                default=["Running Pods", "Deployments", "Node OS"],
                key="eks_scan_scope"
            )
        
        with col2:
            st.markdown("#### üîç Scan Options")
            
            st.checkbox("‚úÖ Runtime Scanning", value=True, key="eks_runtime")
            st.checkbox("‚úÖ Admission Control", value=True, key="eks_admission")
            st.checkbox("‚úÖ RBAC Analysis", value=True, key="eks_rbac")
            st.checkbox("‚ñ° Network Policy Audit", value=False, key="eks_network")
            
            st.markdown("---")
            st.metric("Total Namespaces", "12")
            st.metric("Total Pods", "456")
        
        if st.button("üöÄ Start EKS Vulnerability Scan", type="primary", key="vuln_start_eks_scan", use_container_width=True):
            with st.spinner("Scanning EKS clusters..."):
                import time
                
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                stages = [
                    ("Connecting to EKS clusters...", 10),
                    ("Scanning running pods...", 30),
                    ("Analyzing container images...", 50),
                    ("Checking RBAC permissions...", 70),
                    ("Scanning node OS...", 85),
                    ("Generating report...", 100)
                ]
                
                for stage, progress in stages:
                    status_text.text(stage)
                    progress_bar.progress(progress)
                    time.sleep(0.7)
                
                status_text.empty()
                progress_bar.empty()
                
                st.success("‚úÖ Scan complete! Found 78 vulnerabilities across 4 clusters")
        
        st.markdown("---")
        
        # EKS vulnerability results
        st.markdown("### üìä EKS Vulnerability Results")
        
        # Pod vulnerabilities
        with st.expander("üöÄ Pod & Container Vulnerabilities (45)", expanded=True):
            pod_vulns = [
                {
                    'Cluster': 'prod-eks-cluster-01',
                    'Namespace': 'production',
                    'Pod': 'api-deployment-7d9f8',
                    'Container': 'api-service',
                    'CVE': 'CVE-2024-5555',
                    'Severity': 'üî¥ Critical',
                    'CVSS': '9.3',
                    'Description': 'RCE in application dependency',
                    'Remediation': 'Update dependency in requirements.txt',
                    'Status': 'Fix Available'
                },
                {
                    'Cluster': 'prod-eks-cluster-02',
                    'Namespace': 'production',
                    'Pod': 'worker-7b8c9',
                    'Container': 'celery-worker',
                    'CVE': 'CVE-2024-6666',
                    'Severity': 'üü† High',
                    'CVSS': '8.1',
                    'Description': 'Privilege escalation',
                    'Remediation': 'Apply security context constraints',
                    'Status': 'Manual Review Required'
                },
                {
                    'Cluster': 'staging-eks-cluster',
                    'Namespace': 'staging',
                    'Pod': 'web-frontend-5c7d',
                    'Container': 'nginx',
                    'CVE': 'CVE-2024-7777',
                    'Severity': 'üü° Medium',
                    'CVSS': '6.5',
                    'Description': 'Information disclosure',
                    'Remediation': 'Update nginx to 1.25.3',
                    'Status': 'Fix Available'
                }
            ]
            
            df_pods = pd.DataFrame(pod_vulns)
            st.dataframe(df_pods, use_container_width=True, hide_index=True)
        
        # Configuration issues
        with st.expander("‚öôÔ∏è Kubernetes Configuration Issues (23)", expanded=True):
            config_issues = [
                {
                    'Cluster': 'prod-eks-cluster-01',
                    'Resource': 'Deployment: api-service',
                    'Issue': 'Container running as root',
                    'Severity': 'üü† High',
                    'Risk': 'Privilege escalation',
                    'NIST': 'AC-6',
                    'Remediation': 'Add securityContext with runAsNonRoot',
                    'Auto-Fix': '‚úÖ Yes'
                },
                {
                    'Cluster': 'prod-eks-cluster-02',
                    'Resource': 'Pod: monitoring-agent',
                    'Issue': 'Privileged container',
                    'Severity': 'üî¥ Critical',
                    'Risk': 'Full node access',
                    'NIST': 'AC-6, SC-39',
                    'Remediation': 'Remove privileged: true unless required',
                    'Auto-Fix': '‚ùå Manual'
                },
                {
                    'Cluster': 'staging-eks-cluster',
                    'Resource': 'Namespace: default',
                    'Issue': 'No NetworkPolicy defined',
                    'Severity': 'üü° Medium',
                    'Risk': 'Unrestricted network access',
                    'NIST': 'SC-7',
                    'Remediation': 'Create default-deny NetworkPolicy',
                    'Auto-Fix': '‚úÖ Yes'
                }
            ]
            
            df_config = pd.DataFrame(config_issues)
            st.dataframe(df_config, use_container_width=True, hide_index=True)
        
        # Node OS vulnerabilities
        with st.expander("üñ•Ô∏è EKS Node OS Vulnerabilities (10)", expanded=True):
            node_vulns = [
                {
                    'Node': 'ip-10-0-1-45.ec2.internal',
                    'OS': 'Amazon Linux 2',
                    'CVE': 'CVE-2024-8888',
                    'Severity': 'üü† High',
                    'Package': 'kernel 5.10.201',
                    'Fix': 'Update to kernel 5.10.210',
                    'Impact': '8 running pods'
                },
                {
                    'Node': 'ip-10-0-2-67.ec2.internal',
                    'OS': 'Amazon Linux 2',
                    'CVE': 'CVE-2024-9999',
                    'Severity': 'üü° Medium',
                    'Package': 'containerd 1.6.24',
                    'Fix': 'Update to containerd 1.7.11',
                    'Impact': '12 running pods'
                }
            ]
            
            df_nodes = pd.DataFrame(node_vulns)
            st.dataframe(df_nodes, use_container_width=True, hide_index=True)
        
        # EKS actions
        st.markdown("---")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button("üî® Deploy Fixes", key="vuln_deploy_fixes", use_container_width=True):
                st.info("Deploying security fixes to EKS clusters...")
        
        with col2:
            if st.button("üõ°Ô∏è Apply Policies", key="vuln_apply_policies", use_container_width=True):
                st.success("Applied Pod Security Standards to all namespaces")
        
        with col3:
            if st.button("üîÑ Rolling Update", key="vuln_rolling_update", use_container_width=True):
                st.info("Performing rolling update of vulnerable pods...")
        
        with col4:
            if st.button("üìä Export Report", key="vuln_export_eks", use_container_width=True):
                st.info("EKS vulnerability report exported")
    
    @staticmethod
    def _render_auto_remediation(session, region: str):
        """Auto-Remediation Engine"""
        st.markdown("### üîß Auto-Remediation Engine")
        st.info("Automatically fix vulnerabilities with confidence-based remediation")
        
        # Remediation dashboard
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("Auto-Remediable", "127", delta="51% of total")
        
        with col2:
            st.metric("Remediated Today", "45", delta="‚Üë 12 from yesterday")
        
        with col3:
            st.metric("Success Rate", "96.8%", delta="‚Üë 1.2%")
        
        with col4:
            st.metric("Time Saved", "18 hours", delta="This week")
        
        st.markdown("---")
        
        # Remediation rules
        st.markdown("### üìã Auto-Remediation Rules")
        
        rules_data = [
            {
                'Rule Name': 'Windows Critical Patches',
                'Trigger': 'CVSS >= 9.0 AND OS = Windows',
                'Action': 'Install Windows Update via SSM',
                'Confidence': '98%',
                'Requires Approval': 'No',
                'Executions': '247',
                'Success Rate': '99.2%',
                'Status': '‚úÖ Active'
            },
            {
                'Rule Name': 'Linux Package Updates',
                'Trigger': 'CVSS >= 8.0 AND OS = Linux',
                'Action': 'Run package manager update',
                'Confidence': '95%',
                'Requires Approval': 'No',
                'Executions': '412',
                'Success Rate': '97.8%',
                'Status': '‚úÖ Active'
            },
            {
                'Rule Name': 'Container Image Rebuild',
                'Trigger': 'Critical CVE in base image',
                'Action': 'Trigger CI/CD rebuild',
                'Confidence': '92%',
                'Requires Approval': 'Yes',
                'Executions': '89',
                'Success Rate': '95.5%',
                'Status': '‚úÖ Active'
            },
            {
                'Rule Name': 'EKS Pod Restart',
                'Trigger': 'High CVE in running pod',
                'Action': 'Rolling restart deployment',
                'Confidence': '94%',
                'Requires Approval': 'No',
                'Executions': '156',
                'Success Rate': '98.1%',
                'Status': '‚úÖ Active'
            },
            {
                'Rule Name': 'Privilege De-escalation',
                'Trigger': 'Container running as root',
                'Action': 'Apply securityContext',
                'Confidence': '89%',
                'Requires Approval': 'Yes',
                'Executions': '34',
                'Success Rate': '91.2%',
                'Status': '‚úÖ Active'
            }
        ]
        
        df_rules = pd.DataFrame(rules_data)
        st.dataframe(df_rules, use_container_width=True, hide_index=True)
        
        # Pending remediations
        st.markdown("---")
        st.markdown("### ‚è≥ Pending Auto-Remediations")
        
        pending = [
            {
                'Resource': 'prod-web-01 (Windows)',
                'Vulnerability': 'CVE-2024-1234 (Critical)',
                'Remediation': 'Install KB5034441',
                'Confidence': '98%',
                'Approval': 'Not Required',
                'ETA': '2 minutes',
                'Status': 'Ready'
            },
            {
                'Resource': 'prod/api-service:v2.1.0',
                'Vulnerability': 'CVE-2024-1111 (Critical)',
                'Remediation': 'Rebuild with updated dependencies',
                'Confidence': '92%',
                'Approval': 'Required',
                'ETA': '15 minutes',
                'Status': 'Awaiting Approval'
            },
            {
                'Resource': 'prod-app-01 (Ubuntu)',
                'Vulnerability': 'CVE-2024-9012 (Critical)',
                'Remediation': 'apt upgrade sudo',
                'Confidence': '99%',
                'Approval': 'Not Required',
                'ETA': '1 minute',
                'Status': 'Ready'
            }
        ]
        
        df_pending = pd.DataFrame(pending)
        st.dataframe(df_pending, use_container_width=True, hide_index=True)
        
        # Remediation actions
        st.markdown("---")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("‚ö° Execute All Auto-Remediations", type="primary", key="vuln_exec_all_rem", use_container_width=True):
                with st.spinner("Executing remediations..."):
                    import time
                    time.sleep(2)
                    st.success("‚úÖ Executed 45 auto-remediations successfully!")
        
        with col2:
            if st.button("‚úÖ Approve Pending", key="vuln_approve_pend", use_container_width=True):
                st.success("Approved 12 pending remediations")
        
        with col3:
            if st.button("üìä View History", key="vuln_view_history", use_container_width=True):
                st.info("Loading remediation history...")
        
        # Remediation confidence model
        st.markdown("---")
        st.markdown("### üéØ Confidence Scoring Model")
        
        st.markdown("""
        Auto-remediation confidence is calculated using:
        
        - **Historical Success Rate** (40%): Past success of similar remediations
        - **CVE Age** (20%): Time since CVE publication (older = more tested fixes)
        - **Vendor Verification** (20%): Official patch from vendor
        - **Test Environment Results** (15%): Success in staging/test
        - **Rollback Capability** (5%): Ability to rollback if issues occur
        
        **Thresholds:**
        - ‚â• 95% confidence: Auto-remediate without approval
        - 85-94% confidence: Auto-remediate with notification
        - 75-84% confidence: Require approval
        - < 75% confidence: Manual remediation only
        """)
    
    @staticmethod
    def _render_scanner_integration(session, region: str):
        """Scanner Integration Configuration"""
        st.markdown("### üîå Vulnerability Scanner Integration")
        st.info("Configure and manage vulnerability scanner integrations")
        
        # Scanner status
        st.markdown("### üìä Scanner Status")
        
        scanner_status = [
            {
                'Scanner': 'AWS Inspector v2',
                'Type': 'AWS Native',
                'Status': 'üü¢ Connected',
                'Coverage': 'EC2, ECR, Lambda',
                'Last Scan': '10 min ago',
                'Findings': '89',
                'Cost': 'Included',
                'Action': 'Configure'
            },
            {
                'Scanner': 'AWS Security Hub',
                'Type': 'AWS Native',
                'Status': 'üü¢ Connected',
                'Coverage': 'All Resources',
                'Last Scan': '5 min ago',
                'Findings': '234',
                'Cost': 'Included',
                'Action': 'Configure'
            },
            {
                'Scanner': 'Trivy',
                'Type': 'Open Source',
                'Status': 'üü¢ Connected',
                'Coverage': 'Containers, IaC',
                'Last Scan': '2 hours ago',
                'Findings': '156',
                'Cost': 'Free',
                'Action': 'Configure'
            },
            {
                'Scanner': 'Qualys Cloud Agent',
                'Type': 'Commercial',
                'Status': 'üî¥ Not Connected',
                'Coverage': 'N/A',
                'Last Scan': 'N/A',
                'Findings': '0',
                'Cost': 'License Required',
                'Action': 'Connect'
            },
            {
                'Scanner': 'Snyk Container',
                'Type': 'Commercial',
                'Status': 'üü° Trial',
                'Coverage': 'Containers',
                'Last Scan': '1 day ago',
                'Findings': '78',
                'Cost': 'Free Tier',
                'Action': 'Upgrade'
            },
            {
                'Scanner': 'Aqua Security',
                'Type': 'Commercial',
                'Status': 'üî¥ Not Connected',
                'Coverage': 'N/A',
                'Last Scan': 'N/A',
                'Findings': '0',
                'Cost': 'License Required',
                'Action': 'Connect'
            }
        ]
        
        df_scanners = pd.DataFrame(scanner_status)
        st.dataframe(df_scanners, use_container_width=True, hide_index=True)
        
        # Add new scanner
        st.markdown("---")
        st.markdown("### ‚ûï Add New Scanner")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            new_scanner = st.selectbox(
                "Select Scanner to Add",
                options=[
                    "Qualys VMDR",
                    "Rapid7 InsightVM",
                    "Tenable.io",
                    "Grype",
                    "Clair",
                    "Anchore Engine",
                    "JFrog Xray",
                    "Custom Scanner (API)"
                ],
                key="new_scanner"
            )
            
            st.text_input(
                "API Endpoint",
                placeholder="https://api.qualys.com/v1",
                key="scanner_api"
            )
            
            st.text_input(
                "API Key / Token",
                type="password",
                placeholder="Enter API key",
                key="scanner_key"
            )
        
        with col2:
            st.markdown("**Configuration:**")
            
            st.checkbox("Enable automatic scanning", value=True, key="auto_scan")
            st.checkbox("Enable auto-remediation", value=False, key="auto_rem")
            st.checkbox("Export findings to Security Hub", value=True, key="export_sh")
            
            scan_schedule = st.selectbox(
                "Scan Schedule",
                options=["Hourly", "Every 6 hours", "Daily", "Weekly"],
                key="scan_schedule"
            )
        
        if st.button("‚ûï Add Scanner", type="primary", key="vuln_add_scanner"):
            st.success(f"‚úÖ {new_scanner} added successfully!")
            st.info("Performing initial scan...")
        
        # NIST NVD Integration
        st.markdown("---")
        st.markdown("### üìö NIST NVD Database Integration")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("NVD Database", "Current", delta="Updated daily")
        
        with col2:
            st.metric("Total CVEs", "247,583", delta="+245 today")
        
        with col3:
            st.metric("Last Sync", "2 hours ago", delta="Next: 10 PM")
        
        st.checkbox("‚úÖ Automatically sync with NIST NVD", value=True, key="nist_sync")
        st.checkbox("‚úÖ Enable CVE enrichment", value=True, key="cve_enrich")
        st.checkbox("‚úÖ Map to NIST 800-53 controls", value=True, key="nist_map")
        
        if st.button("üîÑ Sync Now", key="vuln_sync_nist", use_container_width=True):
            with st.spinner("Syncing with NIST NVD database..."):
                import time
                time.sleep(1.5)
                st.success("‚úÖ Synced! Downloaded 245 new CVEs")
    @staticmethod
    def _render_plugin_management(registry):
        """Plugin Management Interface - NEW"""
        st.markdown("### üéõÔ∏è Scanner Plugin Management")
        st.info("üîå Manage security scanner plugins - enable/disable, configure, and add custom scanners")
        
        # Use the PluginUI component
        PluginUI.render_plugin_selector(registry)
        
        # Plugin statistics
        st.markdown("---")
        st.markdown("### üìä Plugin Statistics")
        
        all_plugins = registry.get_all_plugins()
        enabled_plugins = registry.get_enabled_plugins()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("Total Scanners", len(all_plugins))
        
        with col2:
            st.metric("Active Scanners", len(enabled_plugins))
        
        with col3:
            st.metric("Container Scanners", len(registry.get_plugins_by_category('Container Security')))
        
        with col4:
            st.metric("OS Scanners", len(registry.get_plugins_by_category('OS Vulnerability')))
        
        # Quick actions
        st.markdown("---")
        st.markdown("### ‚ö° Quick Actions")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üîÑ Refresh Scanners", key=f"refresh_plugins_{st.session_state.vuln_session_id}"):
                st.success("‚úÖ Scanner list refreshed")
        
        with col2:
            if st.button("‚úÖ Enable All", key=f"enable_all_{st.session_state.vuln_session_id}"):
                for plugin in registry.get_all_plugins().values():
                    plugin.enabled = True
                st.success("‚úÖ All scanners enabled")
        
        with col3:
            if st.button("‚ùå Disable All", key=f"disable_all_{st.session_state.vuln_session_id}"):
                for plugin in registry.get_all_plugins().values():
                    plugin.enabled = False
                st.warning("‚ö†Ô∏è All scanners disabled")